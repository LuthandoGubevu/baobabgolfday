
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check for admin privileges based on email.
    function isAdmin() {
      return request.auth != null && request.auth.token.email in ["roslyn@baobabbrands.com", "royden@baobabbrands.com", "ross@baobabbrands.com"];
    }

    // Bookings collection rules
    match /bookings/{bookingId} {
      // Admins can read, update, or delete any booking.
      allow read, update, delete: if isAdmin();
      
      // Anyone can create a booking. This is a public-facing form.
      allow create: if true;

      // Admins can list all bookings
      allow list: if isAdmin();
    }

    // Holes collection rules
    match /holes/{holeId} {
      // Anyone can read the status of the holes to see what's available.
      allow read: if true;
      
      // Admins can write to any hole document directly (e.g., to manually block one).
      // Additionally, a non-admin can update a hole document ONLY IF:
      // 1. They are only changing the 'status' to 'pending' and updating booking-related fields.
      // 2. This update is part of a transaction where they are also creating a new booking document.
      allow write: if isAdmin() || 
                      (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'bookingId', 'companyName', 'contactName', 'email']) &&
                       request.resource.data.status == 'pending' &&
                       getAfter(/databases/$(database)/documents/bookings/$(request.resource.data.bookingId)).data.sponsoredHoleNumber == holeId);
    }

    // Messages collection rules
    match /messages/{messageId} {
      // Admins can read and delete messages.
      allow read, delete: if isAdmin();
      // Anyone can create a message through the contact form.
      allow create: if true;
    }

    // Reminders collection rules
    match /reminders/{reminderId} {
       // Admins can read and delete reminders.
      allow read, delete: if isAdmin();
       // Anyone can create a reminder.
      allow create: if true;
    }
  }
}
